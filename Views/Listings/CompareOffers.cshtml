@model ServiceMarketplace.Models.Listing

@{
    ViewData["Title"] = "Teklif KarÅŸÄ±laÅŸtÄ±rma";
    var offers = Model.Offers.Where(o => o.Status != "Cancelled").OrderBy(o => o.TotalOfferPrice).ToList();
    var packageItems = Model.ServicePackage?.Items?.OrderBy(i => i.DisplayOrder).ToList();
    var lowestTotal = offers.Any() ? offers.Min(o => o.TotalOfferPrice) : 0;
    var hasAccepted = offers.Any(o => o.Status == "Accepted");
}

<div class="container py-4">

    <!-- Alerts -->
    @if (TempData["Success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="bi bi-check-circle"></i> @TempData["Success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["Error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["Error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Ä°lan Ã–zet KartÄ± -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    @if (Model.ServicePackage != null)
                    {
                        <span class="badge bg-primary mb-2">@Model.ServicePackage.Code</span>
                        <h2 class="fw-bold mb-1">@Model.ServicePackage.Name</h2>
                    }
                    else
                    {
                        <h2 class="fw-bold mb-1">@Model.Title</h2>
                    }
                    <p class="text-muted mb-0">
                        <i class="bi bi-geo-alt"></i> @Model.Location
                        <span class="mx-2">&bull;</span>
                        <i class="bi bi-calendar"></i> @Model.CreatedAt.ToString("dd.MM.yyyy")
                        <span class="mx-2">&bull;</span>
                        <i class="bi bi-rulers"></i> @Model.Area mÂ²
                    </p>
                    @if (!string.IsNullOrEmpty(Model.Dimensions))
                    {
                        <p class="text-muted small mb-0 mt-1">
                            <i class="bi bi-bounding-box"></i> Boyutlar: @Model.Dimensions
                        </p>
                    }
                </div>
                <div class="text-end">
                    <span class="badge bg-info fs-6">@offers.Count Teklif</span>
                    <br class="mt-2">
                    <a asp-action="MyListings" class="btn btn-outline-secondary btn-sm mt-2">
                        <i class="bi bi-arrow-left"></i> Ä°lanlarÄ±ma DÃ¶n
                    </a>
                </div>
            </div>
        </div>
    </div>

    @if (!offers.Any())
    {
        <div class="alert alert-warning text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem;"></i>
            <h4 class="mt-3">HenÃ¼z teklif gelmedi</h4>
            <p class="text-muted">TedarikÃ§iler ilanÄ±nÄ±zÄ± inceliyor, teklifler geldiÄŸinde burada karÅŸÄ±laÅŸtÄ±rabileceksiniz.</p>
        </div>
    }
    else
    {
        @if (hasAccepted)
        {
            <div class="alert alert-success">
                <i class="bi bi-check-circle-fill"></i>
                <strong>Bir teklif kabul edildi!</strong> AÅŸaÄŸÄ±da son durum gÃ¶rÃ¼ntÃ¼lenmektedir.
            </div>
        }

        <!-- Filtre ButonlarÄ± -->
        <div class="mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary active" onclick="filterOffers('all', this)">TÃ¼mÃ¼ (@offers.Count)</button>
                @{
                    var materialCount = offers.Count(o => o.OfferType == "Material");
                    var laborCount = offers.Count(o => o.OfferType == "Labor");
                }
                @if (materialCount > 0)
                {
                    <button type="button" class="btn btn-outline-primary" onclick="filterOffers('Material', this)">
                        <i class="bi bi-box-seam"></i> Malzeme (@materialCount)
                    </button>
                }
                @if (laborCount > 0)
                {
                    <button type="button" class="btn btn-outline-success" onclick="filterOffers('Labor', this)">
                        <i class="bi bi-tools"></i> Ä°ÅŸÃ§ilik (@laborCount)
                    </button>
                }
            </div>
        </div>

        <!-- KarÅŸÄ±laÅŸtÄ±rma Tablosu -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle mb-0" id="compareTable">
                        <thead class="table-dark">
                            <tr>
                                <th style="min-width: 180px; position: sticky; left: 0; z-index: 2; background: #212529;">Paket Kalemi</th>
                                @foreach (var offer in offers)
                                {
                                    var supplierName = offer.User?.CompanyName ?? offer.User?.FullName ?? "TedarikÃ§i";
                                    <th class="text-center @(offer.Status == "Accepted" ? "table-success" : "")" style="min-width: 220px;" data-offer-type="@offer.OfferType">
                                        <div class="fw-bold">@supplierName</div>
                                        <small class="opacity-75">
                                            @(offer.OfferType == "Material" ? "ðŸ§± Malzeme" : "ðŸ‘· Ä°ÅŸÃ§ilik")
                                        </small>
                                        @if (offer.Status == "Accepted")
                                        {
                                            <br><span class="badge bg-success mt-1">âœ“ Kabul Edildi</span>
                                        }
                                        else if (offer.Status == "Rejected")
                                        {
                                            <br><span class="badge bg-danger mt-1">Reddedildi</span>
                                        }
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            @if (packageItems != null && packageItems.Any())
                            {
                                @foreach (var item in packageItems)
                                {
                                    var itemPrices = offers
                                        .Select(o => o.LineItems?.FirstOrDefault(li => li.PackageItemId == item.Id))
                                        .Where(li => li != null && li.LineTotal > 0)
                                        .Select(li => li.LineTotal)
                                        .ToList();
                                    var lowestItemPrice = itemPrices.Any() ? itemPrices.Min() : 0;

                                    <tr>
                                        <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 1;">
                                            <strong>@item.Name</strong>
                                            <br><small class="text-muted">@item.MainCategory &bull; @item.Unit</small>
                                        </td>
                                        @foreach (var offer in offers)
                                        {
                                            var lineItem = offer.LineItems?.FirstOrDefault(li => li.PackageItemId == item.Id);
                                            var isCheapest = lineItem != null && lineItem.LineTotal > 0 && lineItem.LineTotal == lowestItemPrice && itemPrices.Count > 1;

                                            <td class="text-center @(isCheapest ? "table-success" : "") @(offer.Status == "Rejected" ? "text-muted" : "")" data-offer-type="@offer.OfferType">
                                                @if (lineItem != null)
                                                {
                                                    <div class="fw-bold">@lineItem.Brand</div>
                                                    <div class="text-muted small">@lineItem.ProductName</div>
                                                    <div class="mt-1">
                                                        <span class="@(isCheapest ? "text-success fw-bold" : "")">
                                                            @lineItem.UnitPrice.ToString("N2") â‚º/@item.Unit
                                                        </span>
                                                    </div>
                                                    <div class="small text-muted">
                                                        @lineItem.Quantity @item.Unit &times; @lineItem.UnitPrice.ToString("N2") â‚º
                                                        = <strong>@lineItem.LineTotal.ToString("N2") â‚º</strong>
                                                    </div>
                                                    @if (isCheapest)
                                                    {
                                                        <span class="badge bg-success-subtle text-success">En Uygun</span>
                                                    }
                                                }
                                                else
                                                {
                                                    <span class="text-muted">â€”</span>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            }
                        </tbody>
                        <tfoot>
                            <!-- TOPLAM FÄ°YAT -->
                            <tr class="table-warning fw-bold">
                                <td style="position: sticky; left: 0; background: #fff3cd; z-index: 1;">
                                    <i class="bi bi-cash-stack"></i> TOPLAM FÄ°YAT
                                </td>
                                @foreach (var offer in offers)
                                {
                                    var isCheapestTotal = offer.TotalOfferPrice == lowestTotal && offers.Count > 1;
                                    <td class="text-center fs-5" data-offer-type="@offer.OfferType">
                                        <span class="@(isCheapestTotal ? "text-success" : "")">
                                            â‚º@offer.TotalOfferPrice.ToString("N2")
                                        </span>
                                        @if (isCheapestTotal)
                                        {
                                            <br><span class="badge bg-success">En Uygun Teklif</span>
                                        }
                                    </td>
                                }
                            </tr>
                            <!-- SÃ¼re -->
                            <tr>
                                <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 1;">
                                    <i class="bi bi-calendar3"></i> Tahmini SÃ¼re
                                </td>
                                @{
                                    var shortestDays = offers.Where(o => o.EstimatedDays > 0).Any()
                                        ? offers.Where(o => o.EstimatedDays > 0).Min(o => o.EstimatedDays) : 0;
                                }
                                @foreach (var offer in offers)
                                {
                                    var isShortest = offer.EstimatedDays > 0 && offer.EstimatedDays == shortestDays && offers.Count > 1;
                                    <td class="text-center" data-offer-type="@offer.OfferType">
                                        <strong class="@(isShortest ? "text-success" : "")">@offer.EstimatedDays gÃ¼n</strong>
                                        @if (isShortest)
                                        {
                                            <span class="badge bg-success-subtle text-success ms-1">En HÄ±zlÄ±</span>
                                        }
                                    </td>
                                }
                            </tr>
                            <!-- Garanti -->
                            <tr>
                                <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 1;">
                                    <i class="bi bi-shield-check"></i> Garanti SÃ¼resi
                                </td>
                                @{
                                    var longestWarranty = offers.Where(o => o.WarrantyMonths > 0).Any()
                                        ? offers.Max(o => o.WarrantyMonths) : 0;
                                }
                                @foreach (var offer in offers)
                                {
                                    var isLongest = offer.WarrantyMonths > 0 && offer.WarrantyMonths == longestWarranty && offers.Count > 1;
                                    <td class="text-center" data-offer-type="@offer.OfferType">
                                        <strong class="@(isLongest ? "text-success" : "")">@offer.WarrantyMonths ay</strong>
                                        @if (isLongest)
                                        {
                                            <span class="badge bg-success-subtle text-success ms-1">En Uzun</span>
                                        }
                                    </td>
                                }
                            </tr>
                            <!-- Teklif Tarihi -->
                            <tr>
                                <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 1;">
                                    <i class="bi bi-clock"></i> Teklif Tarihi
                                </td>
                                @foreach (var offer in offers)
                                {
                                    <td class="text-center" data-offer-type="@offer.OfferType">
                                        @offer.CreatedAt.ToString("dd.MM.yyyy HH:mm")
                                    </td>
                                }
                            </tr>
                            <!-- Ä°ÅŸlem ButonlarÄ± -->
                            <tr>
                                <td style="position: sticky; left: 0; background: #f8f9fa; z-index: 1;">
                                    <i class="bi bi-lightning"></i> Ä°ÅŸlem
                                </td>
                                @foreach (var offer in offers)
                                {
                                    <td class="text-center" data-offer-type="@offer.OfferType">
                                        @if (offer.Status == "Pending" && !hasAccepted)
                                        {
                                            <form asp-action="AcceptOffer" method="post"
                                                  onsubmit="return confirm('Bu teklifi kabul etmek istediÄŸinize emin misiniz?\nDiÄŸer teklifler otomatik reddedilecektir.');">
                                                @Html.AntiForgeryToken()
                                                <input type="hidden" name="offerId" value="@offer.Id" />
                                                <button type="submit" class="btn btn-success btn-lg w-100">
                                                    <i class="bi bi-check-lg"></i> Kabul Et
                                                </button>
                                            </form>
                                        }
                                        else if (offer.Status == "Accepted")
                                        {
                                            <span class="btn btn-outline-success btn-lg w-100 disabled">
                                                <i class="bi bi-check-circle-fill"></i> Kabul Edildi
                                            </span>
                                        }
                                        else if (offer.Status == "Rejected")
                                        {
                                            <span class="btn btn-outline-secondary w-100 disabled">
                                                Reddedildi
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="btn btn-outline-secondary w-100 disabled">
                                                @offer.Status
                                            </span>
                                        }

                                        <div class="mt-2">
                                            <a asp-controller="Offers" asp-action="Details" asp-route-id="@offer.Id"
                                               class="btn btn-outline-info btn-sm">
                                                <i class="bi bi-eye"></i> Detay
                                            </a>
                                            <a asp-controller="Offers" asp-action="DownloadPdf" asp-route-id="@offer.Id"
                                               class="btn btn-outline-primary btn-sm">
                                                <i class="bi bi-file-pdf"></i> PDF
                                            </a>
                                        </div>
                                    </td>
                                }
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- AÃ§Ä±klama -->
        <div class="mt-3">
            <small class="text-muted">
                <span class="badge bg-success-subtle text-success">En Uygun</span> = Bu kategoride en iyi deÄŸer
                &nbsp;&bull;&nbsp; Tablo yatay kaydÄ±rÄ±labilir
            </small>
        </div>
    }
</div>

@section Scripts {
    <script>
        function filterOffers(type, btn) {
            // Toggle active button
            document.querySelectorAll('.btn-group .btn').forEach(function(b) {
                b.classList.remove('active');
            });
            btn.classList.add('active');

            // Show/hide columns
            document.querySelectorAll('[data-offer-type]').forEach(function(cell) {
                if (type === 'all') {
                    cell.style.display = '';
                } else {
                    cell.style.display = cell.dataset.offerType === type ? '' : 'none';
                }
            });
        }
    </script>
}
